<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gael & Mar</title>
    <style>
        :root { --accent: #a29bfe; --bg: #000000; --card: #111111; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }

        /* Vistas Principal */
        .view { display: none; height: 100vh; padding: 30px 20px; overflow-y: auto; padding-bottom: 120px; }
        .view.active { display: block; animation: fadeIn 0.4s ease; }

        /* Navegaci√≥n Minimal */
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(20,20,20,0.8); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { color: #444; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent); transform: scale(1.2); }

        /* Tarjetas Estilo Apple */
        .card { background: var(--card); border-radius: 28px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        h1 { font-weight: 300; letter-spacing: -1px; margin: 0; }
        #timer { font-size: 1.8rem; font-weight: 200; margin: 15px 0; color: var(--accent); }

        /* Chat Minimal */
        #chat-box { height: 50vh; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 0.95rem; }
        .msg.yo { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .msg.otro { align-self: flex-start; background: #222; border-bottom-left-radius: 4px; }

        /* ALERTA GIGANTE (El "Algo m√°s") */
        #big-alert { 
            position: fixed; inset: 0; background: var(--accent); color: #000; 
            z-index: 5000; display: none; align-items: center; justify-content: center; 
            flex-direction: column; text-align: center; font-weight: bold; animation: alertPop 0.5s ease;
        }
        #big-alert h1 { font-size: 3rem; -webkit-text-fill-color: #000; }

        /* Pizarra Cuadrada Perfecta */
        .canvas-container { width: 100%; aspect-ratio: 1/1; background: #fff; border-radius: 24px; overflow: hidden; touch-action: none; }
        canvas { width: 100%; height: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes alertPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #login { position: fixed; inset: 0; background: #000; z-index: 9000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px; }
        button { background: var(--accent); border: none; padding: 15px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; width: 80%; }
        input { background: #1a1a1a; border: none; color: white; padding: 15px; border-radius: 15px; width: 100%; }
    </style>
</head>
<body>

    <div id="login">
        <h1 style="margin-bottom: 20px;">Gael & Mar</h1>
        <button onclick="login('Gael')">Soy Gael</button>
        <button style="background: #fff;" onclick="login('Mar')">Soy Mar</button>
    </div>

    <div id="big-alert">
        <p id="alert-user" style="text-transform: uppercase; letter-spacing: 2px;">MENSAJE DE AMOR</p>
        <h1 id="alert-text">TE EXTRA√ëO</h1>
        <span style="font-size: 4rem;">‚ù§Ô∏è</span>
    </div>

    <div id="home" class="view active">
        <div style="text-align: center; margin-top: 40px;">
            <h1 id="welcome-name">Hola</h1>
            <div id="timer">00d 00h 00m 00s</div>
            <p style="opacity: 0.4;">Juntos desde el 31.12.25</p>
        </div>

        <div class="card" style="margin-top: 40px;">
            <p style="margin-bottom: 15px; opacity: 0.6;">Enviar un toque r√°pido:</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="sendBigAlert('¬°TE EXTRA√ëO!')" style="background: #222; color: #fff;">Te extra√±o</button>
                <button onclick="sendBigAlert('¬°TE AMO!')" style="background: #222; color: #fff;">Te amo</button>
                <button onclick="sendBigAlert('¬øCENAMOS? üçï')" style="background: #222; color: #fff;">¬øCenamos?</button>
                <button onclick="sendBigAlert('M√çRAME üòò')" style="background: #222; color: #fff;">M√≠rame</button>
            </div>
        </div>
    </div>

    <div id="chat" class="view">
        <div id="chat-box"></div>
        <div style="padding: 10px; display: flex; gap: 10px;">
            <input type="text" id="msgInput" placeholder="Escribe aqu√≠...">
            <button onclick="sendMessage()" style="width: auto;">Enviar</button>
        </div>
    </div>

    <div id="draw" class="view">
        <h2 style="text-align: center; font-weight: 300;">Lienzo Compartido</h2>
        <div class="canvas-container"><canvas id="pizarra"></canvas></div>
        <button onclick="clearCanvas()" style="background: none; border: 1px solid #333; color: #555; margin-top: 20px;">Limpiar Lienzo</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home')">üè†</div>
        <div class="nav-item" onclick="switchTab('chat')">üí¨</div>
        <div class="nav-item" onclick="switchTab('draw')">üé®</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmChW_AAw3n_gZBZ29rgX8CJonRhooVTE",
            authDomain: "appmar-3bb00.firebaseapp.com",
            databaseURL: "https://appmar-3bb00-default-rtdb.firebaseio.com",
            projectId: "appmar-3bb00",
            storageBucket: "appmar-3bb00.firebasestorage.app",
            messagingSenderId: "762733783465",
            appId: "1:762733783465:web:25a57b8ae450b83ba83cb8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const me = localStorage.getItem('user');

        window.login = (u) => { localStorage.setItem('user', u); location.reload(); };
        if(me) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('welcome-name').innerText = "Hola " + me;
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.view, .nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tab === 'draw') setupCanvas();
        };

        // --- CONTADOR ---
        setInterval(() => {
            const diff = new Date().getTime() - new Date('2025-12-31T00:00:00').getTime();
            const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            document.getElementById('timer').innerText = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);

        // --- ALERTA GRANDE (Punto 3) ---
        window.sendBigAlert = (txt) => {
            set(ref(db, 'alert'), { from: me, text: txt, time: Date.now() });
        };

        onValue(ref(db, 'alert'), (snap) => {
            const data = snap.val();
            if(data && data.from !== me) {
                const overlay = document.getElementById('big-alert');
                document.getElementById('alert-user').innerText = data.from + " dice:";
                document.getElementById('alert-text').innerText = data.text;
                overlay.style.display = 'flex';
                setTimeout(() => overlay.style.display = 'none', 3500);
            }
        });

        // --- CHAT ---
        window.sendMessage = () => {
            const input = document.getElementById('msgInput');
            if(input.value) { push(ref(db, 'chat'), { u: me, t: input.value }); input.value = ''; }
        };
        onChildAdded(ref(db, 'chat'), (snap) => {
            const m = snap.val();
            const div = document.createElement('div');
            div.className = `msg ${m.u === me ? 'yo' : 'otro'}`;
            div.innerText = m.t;
            document.getElementById('chat-box').appendChild(div);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        });

        // --- PIZARRA ---
        const canvas = document.getElementById('pizarra');
        const ctx = canvas.getContext('2d');
        function setupCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.width;
            ctx.strokeStyle = "#a29bfe"; ctx.lineWidth = 4; ctx.lineCap = "round";
        }
        const sendStroke = (e, type) => {
            const rect = canvas.getBoundingClientRect();
            const x = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / canvas.width;
            const y = ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top) / canvas.height;
            push(ref(db, 'draw'), { x, y, type });
        };
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); sendStroke(e, 'start'); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); sendStroke(e, 'move'); }, {passive: false});
        onValue(ref(db, 'draw'), (snap) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            snap.forEach(c => {
                const p = c.val();
                if(p.type === 'start') { ctx.beginPath(); ctx.moveTo(p.x*canvas.width, p.y*canvas.height); }
                else { ctx.lineTo(p.x*canvas.width, p.y*canvas.height); ctx.stroke(); }
            });
        });
        window.clearCanvas = () => remove(ref(db, 'draw'));

    </script>
</body>
</html>
