<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gael & Mar</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --morado: #a29bfe; --fondo: #0f0c29; --tarjeta: rgba(255, 255, 255, 0.05); }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            color: white; margin: 0; padding: 20px;
        }

        /* Dise√±o de App Real */
        .glass { background: var(--tarjeta); backdrop-filter: blur(10px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; margin-bottom: 20px; }
        
        .header h1 { font-size: 1.8rem; margin: 0; background: linear-gradient(to right, #fff, var(--morado)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #contador { font-size: 1rem; opacity: 0.8; margin-top: 5px; letter-spacing: 1px; }

        /* Pizarra Arreglada para Celular */
        #pizarra-container { 
            width: 100%; height: 300px; background: #fff; border-radius: 20px; 
            position: relative; overflow: hidden; touch-action: none; /* Bloquea el scroll al dibujar */
        }
        canvas { width: 100%; height: 100%; cursor: crosshair; }

        /* Botones y Tags */
        .tag { 
            background: rgba(162, 155, 254, 0.2); border: 1px solid var(--morado);
            padding: 10px 18px; border-radius: 15px; color: white; font-size: 0.9rem;
            margin: 5px; display: inline-block; transition: 0.3s;
        }
        .tag:active { background: var(--morado); transform: scale(0.9); }

        .btn-main { 
            background: var(--morado); color: #24243e; border: none; 
            padding: 12px 20px; border-radius: 12px; font-weight: bold; width: 100%;
        }

        input { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 12px; border-radius: 12px; width: calc(100% - 24px); margin-bottom: 10px;
        }

        /* Identificaci√≥n */
        #overlay { position: fixed; inset: 0; background: #0f0c29; z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="overlay">
        <h2>¬øQui√©n eres hoy? ‚ù§Ô∏è</h2>
        <button class="tag" style="padding: 20px" onclick="setUsuario('Gael')">Soy Gael</button>
        <button class="tag" style="padding: 20px" onclick="setUsuario('Mar')">Soy Mar</button>
    </div>

    <div class="header" style="text-align: center; margin-bottom: 30px;">
        <h1 id="saludo">Hola Amor</h1>
        <div id="contador" class="glass">Cargando nuestro tiempo...</div>
    </div>

    <div class="glass">
        <h3>Pizarra M√°gica üé®</h3>
        <div id="pizarra-container">
            <canvas id="pizarra"></canvas>
        </div>
        <button onclick="clearCanvas()" style="margin-top:10px; background:none; border:none; color:#ff7675;">Limpiar Pizarra</button>
    </div>

    <div class="glass">
        <h3>Env√≠a un detalle r√°pido ‚ú®</h3>
        <div id="tagsContainer">
            <button class="tag btn-add" onclick="addNewTag()">+ Crear propia</button>
        </div>
    </div>

    <div class="glass">
        <h3>Nuestra Bucket List ‚úàÔ∏è</h3>
        <input type="text" id="bucketInput" placeholder="Pr√≥xima aventura...">
        <button class="btn-main" onclick="addBucketItem()">A√±adir a la lista</button>
        <div id="listaMetas" style="margin-top: 15px; text-align: left;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmChW_AAw3n_gZBZ29rgX8CJonRhooVTE",
            authDomain: "appmar-3bb00.firebaseapp.com",
            databaseURL: "https://appmar-3bb00-default-rtdb.firebaseio.com",
            projectId: "appmar-3bb00",
            storageBucket: "appmar-3bb00.firebasestorage.app",
            messagingSenderId: "762733783465",
            appId: "1:762733783465:web:25a57b8ae450b83ba83cb8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GESTI√ìN DE USUARIO ---
        window.setUsuario = (nombre) => {
            localStorage.setItem('usuario', nombre);
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('saludo').innerText = "Hola " + nombre + " ‚ù§Ô∏è";
        };
        if(localStorage.getItem('usuario')) setUsuario(localStorage.getItem('usuario'));

        // --- CONTADOR ---
        const fechaIn = new Date('2025-12-31T00:00:00').getTime();
        setInterval(() => {
            const dif = new Date().getTime() - fechaIn;
            const d = Math.floor(dif / 86400000);
            const h = Math.floor((dif % 86400000) / 3600000);
            const m = Math.floor((dif % 3600000) / 60000);
            const s = Math.floor((dif % 60000) / 1000);
            document.getElementById('contador').innerText = `${d}d ${h}h ${m}m ${s}s de nosotros`;
        }, 1000);

        // --- PIZARRA ARREGLADA (TOUCH) ---
        const canvas = document.getElementById('pizarra');
        const ctx = canvas.getContext('2d');
        const drawRef = ref(db, 'pizarra');
        
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.strokeStyle = "#6c5ce7";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / canvas.width, y: (clientY - rect.top) / canvas.height };
        }

        const startDraw = (e) => {
            canvas.isDrawing = true;
            const pos = getPos(e);
            push(drawRef, { x: pos.x, y: pos.y, type: 'start' });
        };

        const moveDraw = (e) => {
            if (!canvas.isDrawing) return;
            e.preventDefault(); // Evita que la pantalla se mueva al dibujar
            const pos = getPos(e);
            push(drawRef, { x: pos.x, y: pos.y, type: 'move' });
        };

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', moveDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', moveDraw, {passive: false});
        window.addEventListener('mouseup', () => canvas.isDrawing = false);
        window.addEventListener('touchend', () => canvas.isDrawing = false);

        onChildAdded(drawRef, (snap) => {
            const p = snap.val();
            if(p.type === 'clear') ctx.clearRect(0,0,canvas.width,canvas.height);
            else {
                ctx[p.type === 'start' ? 'beginPath' : 'lineTo'](p.x*canvas.width, p.y*canvas.height);
                ctx.stroke();
            }
        });
        window.clearCanvas = () => set(drawRef, { type: 'clear' });

        // --- BUCKET LIST ---
        const bRef = ref(db, 'bucket');
        window.addBucketItem = () => {
            const t = document.getElementById('bucketInput').value;
            if(t) { push(bRef, { text: t, check: false }); document.getElementById('bucketInput').value = ''; }
        };
        onChildAdded(bRef, (snap) => {
            const div = document.createElement('div');
            div.className = 'item-meta glass';
            div.style.padding = "10px";
            div.innerHTML = `<input type="checkbox" ${snap.val().check ? 'checked' : ''}> <span>${snap.val().text}</span>`;
            div.querySelector('input').onchange = (e) => update(ref(db, 'bucket/'+snap.key), { check: e.target.checked });
            document.getElementById('listaMetas').prepend(div);
        });

        // --- TAGS ---
        const tRef = ref(db, 'tags');
        window.addNewTag = () => {
            const t = prompt("Nueva frase r√°pida:");
            if(t) push(tRef, { text: t });
        };
        onChildAdded(tRef, (snap) => {
            const b = document.createElement('button');
            b.className = 'tag'; b.innerText = snap.val().text;
            document.getElementById('tagsContainer').insertBefore(b, document.getElementById('tagsContainer').lastElementChild);
        });
    </script>
</body>
</html>
